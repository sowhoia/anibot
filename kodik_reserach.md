# Техническая карта интеграции с Kodik Player

**Kodik располагает полноценным API на kodikapi.com**, который позволяет получить доступ ко всей базе аниме через три основных endpoint'а: поиск, листинг и список озвучек. Для массовой выгрузки данных и создания Telegram-бота наиболее эффективным решением является использование готовой Python-библиотеки **anime-parsers-ru**, которая инкапсулирует работу с API, включая автоматическое получение токена и декодирование прямых ссылок на видео.

## Официальный API Kodik: архитектура и доступ

Kodik предоставляет REST API через домен `kodikapi.com` с тремя ключевыми endpoints. Endpoint `/list` позволяет получить **полный каталог материалов** с пагинацией — именно он критичен для массовой выгрузки. Endpoint `/search` обеспечивает поиск по названию и внешним ID (Shikimori, Kinopoisk, IMDb), а `/translations` возвращает справочник всех доступных озвучек и их идентификаторов.

Авторизация реализована через токен, передаваемый параметром запроса: `?token=YOUR_TOKEN`. Официальный способ получения токена — написать на **support@kodik.biz** с указанием вашего сайта. Документация доступна авторизованным пользователям на `bd.kodik.biz/api/info`. Важно отметить, что библиотека anime-parsers-ru умеет **автоматически извлекать публичный токен** из внутренних скриптов Kodik, хотя такой токен может иметь ограничения.

Формат ответа — JSON со следующей структурой:
```json
{
  "time": "5ms",
  "total": 1520,
  "results": [
    {
      "id": "serial-6647",
      "type": "anime-serial",
      "title": "Наруто [ТВ-1]",
      "title_orig": "Naruto",
      "translation": {"id": 609, "title": "AniDUB", "type": "voice"},
      "year": 2002,
      "last_episode": 220,
      "shikimori_id": "20",
      "kinopoisk_id": "283290"
    }
  ]
}
```

При добавлении параметра `with_material_data=true` API возвращает расширенные данные: **описание, постер, жанры, рейтинги КиноПоиска и IMDb**, актёров и режиссёров. Параметр `with_episodes=true` добавляет структуру сезонов и эпизодов.

## Готовые Python-инструменты для работы с Kodik

Главная библиотека для Python — **anime-parsers-ru** с **55 звёздами на GitHub** и активной поддержкой. Установка: `pip install anime-parsers-ru[lxml]`. Библиотека предоставляет классы `KodikSearch`, `KodikList`, `KodikParser` и их асинхронные версии.

```python
from anime_parsers_ru import KodikParser, KodikList

# Инициализация с автоматическим получением токена
parser = KodikParser()

# Массовая выгрузка списка аниме
data = parser.get_list(
    limit_per_page=100,
    pages_to_parse=None,  # все страницы
    include_material_data=True,
    only_anime=True
)

# Получение прямых m3u8-ссылок на видео
link = parser.get_m3u8_playlist_link(
    id="20", 
    id_type="shikimori",
    seria_num=1,
    translation_id="609",
    quality=720
)
```

Для асинхронных операций используйте `KodikParserAsync`. Библиотека обрабатывает **декодирование зашифрованных видео-ссылок** — Kodik использует кастомную base64-подобную кодировку, которую anime-parsers-ru расшифровывает автоматически, возвращая прямые HLS-плейлисты с `cloud.kodik-storage.com`.

Дополнительные инструменты для комплексного решения:

- **httpx** или **aiohttp** — для асинхронных HTTP-запросов
- **Playwright** — если потребуется рендеринг JavaScript для обхода защит
- **SQLite/PostgreSQL** — для хранения выгруженных данных
- **APScheduler** — для планирования инкрементальных обновлений

## Архитектура решения для массовой выгрузки

Стратегия первичной выгрузки базируется на endpoint `/list` с пагинацией. Kodik возвращает результаты порциями, контролируемыми параметром `limit`. Для **полной выгрузки** необходимо итерировать по страницам до исчерпания данных:

```python
import asyncio
from anime_parsers_ru import KodikParserAsync

async def full_dump():
    parser = KodikParserAsync()
    all_anime = []
    
    # Параллельная выгрузка с ограничением конкурентности
    async with asyncio.Semaphore(5):  # max 5 одновременных запросов
        data = await parser.get_list_async(
            limit_per_page=100,
            include_material_data=True,
            only_anime=True
        )
        all_anime.extend(data.results)
    
    return all_anime
```

Для хранения рекомендуется **PostgreSQL** со следующей схемой: таблицы `anime` (основные данные), `episodes` (серии), `translations` (озвучки) и `anime_translations` (связь многие-ко-многим). Поля `created_at` и `updated_at` из API Kodik позволяют реализовать **инкрементальную синхронизацию** — при последующих запросах фильтруйте по `updated_at` для получения только изменённых записей.

Механизм delta sync:
```python
# Сохраняем timestamp последней синхронизации
# При обновлении запрашиваем только изменения
data = parser.get_list(
    updated_at_from="2025-12-01T00:00:00Z",
    include_material_data=True
)
```

## Rate limiting и технические ограничения

Kodik применяет rate limiting, хотя **конкретные лимиты не документированы**. Библиотека anime-parsers-ru предусматривает исключения `TooManyRequests` (HTTP 429) и `ServiceIsOverloaded` (HTTP 520). Сообщество рекомендует **задержки 1-3 секунды между запросами** для стабильной работы.

Географические блокировки присутствуют — поле `blocked_countries` в ответе API указывает заблокированные регионы (например, Украина). Поле `blocked_seasons` определяет частичные блокировки контента.

Для обхода потенциальных блокировок при массовом парсинге:
- Используйте ротацию User-Agent
- Применяйте экспоненциальный backoff при ошибках
- Рассмотрите использование прокси-пулов для распределения нагрузки
- Соблюдайте разумные интервалы — **100 запросов в минуту** как консервативный лимит

## Правовые аспекты и Terms of Service

Публичные Terms of Service Kodik **не найдены в открытом доступе**. Kodik позиционируется как сервис для встраивания плеера через iframe на партнёрских сайтах. Официальный путь интеграции — обращение на support@kodik.biz для получения API-доступа.

Риски неавторизованного использования:
- Блокировка IP-адреса
- Отзыв или инвалидация токена
- Возможные претензии при коммерческом использовании

**Легальные альтернативы**: оформите официальное партнёрство для production-использования. Для исследовательских и образовательных целей автоматически извлечённые токены функционируют, но без гарантий стабильности.

## Существующие open source проекты

Экосистема решений для работы с Kodik:

| Проект | Звёзды | Описание |
|--------|--------|----------|
| **anime-parsers-ru** | 55 | Главная Python-библиотека с полной поддержкой API |
| **Kodik-Download-Watch** | 46 | Flask-приложение для просмотра и скачивания |
| **kodik-video-links** | 17 | TypeScript-библиотека для прямых ссылок (архив) |
| **kodikwrapper** | - | Node.js/TypeScript обёртка API |
| **kodik-api-rust** | - | Async Rust библиотека |

Для Telegram-ботов готовых open source решений с интеграцией Kodik **не обнаружено**. Коммерческие боты (@animetkabot, @AmiAnimeBot) не публикуют исходный код. Это означает, что решение потребуется разрабатывать самостоятельно, используя anime-parsers-ru как основу и библиотеку **python-telegram-bot** или **aiogram** для Telegram-интеграции.

## Референсная архитектура Telegram-бота

Предлагаемый стек для production-решения:

```
┌─────────────────────────────────────────────────────┐
│                   Telegram Bot                       │
│                  (aiogram 3.x)                       │
├─────────────────────────────────────────────────────┤
│              Business Logic Layer                    │
│   - Поиск аниме, выбор озвучки, выбор серии         │
│   - Inline keyboards для навигации                   │
├─────────────────────────────────────────────────────┤
│              Data Access Layer                       │
│   - PostgreSQL (метаданные аниме)                   │
│   - Redis (кэш, сессии пользователей)               │
├─────────────────────────────────────────────────────┤
│              Kodik Integration                       │
│   - anime-parsers-ru (API wrapper)                  │
│   - Scheduler для delta sync (APScheduler)          │
└─────────────────────────────────────────────────────┘
```

Ключевые компоненты:
- **Первичная выгрузка**: одноразовый скрипт с пагинацией через `/list`
- **Инкрементальное обновление**: cron-задача каждые 6-12 часов, фильтрация по `updated_at`
- **Поиск**: локальный full-text search по PostgreSQL или Elasticsearch
- **Стриминг**: генерация прямых m3u8-ссылок через `get_m3u8_playlist_link()`

## Заключение

Kodik предоставляет полнофункциональный API, достаточный для создания описанного решения. Библиотека anime-parsers-ru покрывает **100% необходимой функциональности** — от массовой выгрузки до получения прямых ссылок на видео. Критический фактор успеха — получение официального токена через support@kodik.biz для стабильной работы в production. При соблюдении rate limits (1-3 секунды между запросами) и использовании инкрементальной синхронизации система будет работать устойчиво без рисков блокировки.